[gcode_macro FILTER_CHAMBER]
gcode:
    {% set TEMP = params.TEMP|default(50)|float %}
    SET_LED LED=case_leds GREEN=0 RED=1 BLUE=0
    M117 Filtering chamber
    RESPOND MSG="Filtering chamber."
    SET_PIN PIN=exhaust_fan VALUE=1
    #SET_PIN PIN=nevermore VALUE=1
    TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={TEMP}
    #SET_PIN PIN=nevermore VALUE=0
    SET_PIN PIN=exhaust_fan VALUE=0
    M117 Filtering DONE
    RESPOND MSG="Filtering done."
    SET_LED LED=case_leds GREEN=1 RED=0 BLUE=0

    

filament_motion_sensor SFS_T0]
detection_length: 10.00 # This can be adjusted to your desired level of sensitivity. 10 is a recomended value to prevent flow dropoff false triggers.
extruder: extruder
switch_pin: PC5
pause_on_runout: True # This can be set to false to debug false positives putting the sensor in "monitor mode". The printer will not pause but it will run the runout_gcode below. 
#event_delay: 3.0
#pause_delay: 0.5
runout_gcode:
    #LCDRGB R=1 G=0 B=0  ; Turn LCD red
    M117 Runout Detected!
    PAUSE   


[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:  
    {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %}  
    {% set x = params.X|default(sensor.park_position_x) %}   
    {% set y = params.Y|default(sensor.park_position_y) %}   
    {% set z = params.Z|default(sensor.park_lift_z)|float %} 
    {% set e = params.E|default(sensor.park_retraction) %}   
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=bed_restore_temp VALUE={printer.heater_bed.target}
    SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=extruder_restore_temp VALUE={printer.extruder.target}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state 
    BASE_PAUSE
    G91
    G1 E-{e} F2100
    G1 Z{z_safe}
    G90
    G1 X{x} Y{y} F6000
    SET_LED LED=OrbiLED RED=1.0 GREEN=1.0 BLUE=0.0

[gcode_macro RESUME]
rename_existing: BASE_RESUME
variable_bed_restore_temp:0
variable_extruder_restore_temp:0
gcode:
    ##### set defaults #####
    {% set sensor = printer['gcode_macro _SENSOR_VARIABLES'] %} 
    M118 Restoring heaters temperature, it might take a whyle!
    M140 S{bed_restore_temp}
    TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_restore_temp}
    M104 S{extruder_restore_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_restore_temp}
    {% set e = params.E|default(sensor.park_retraction) %} 
    G91
    G1 E{e} F2100
    G90    
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME
    SET_LED LED=OrbiLED RED=1.0 GREEN=1.0 BLUE=1.0




# config file version v2.2.03 change note
# 1 - defined user variables at the begining of the file for easier macro parameters adjustment
# 2 - defined disable configuration of features
# 3 - included PAUSE and RESUME macros with restoring bed and hotend temperature featres.

# config file version v2.2.02 change note
# 1 - filament loading will not set hotend temperature to zero in case the hotend was already set hot before the loading / filament change procedure
# 2 - Filament load / unload waits for hotend to reach temp not to reach stabilized temperature - faster filament loading and unloading.
# 3 - Removed messages to screen, only console echo is present
# 4 - Panel beep replaced by M300 / comment it out if not available on your printer
# 5 - unload procedure changed for better filament tip forming.
# 6 - known issue - if printer paused due to runout detection and new filament is not loaded whiting Klipper heaters timeout period (default is 10min) the heaters will be switched OFF. 
      # If user loads new filament autoload with work with its default loading temperature of 230 deg C but the heaters temperature will not be restored afterwards user needs to set back heaters temperature.
      # on my printer this timeout also causes loosing of extruder position and printing can be resumed only after homing first and setting back temperatures manually.


